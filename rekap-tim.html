<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Resmi Tim - Champion Sport Academy</title>
    
    <link rel="icon" type="image/png" href="logo-csa.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Poppins:wght@300;400;500;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: { 
                        maroon: '#630000', 
                        maroonLight: '#8a1c1c',
                        gold: '#D4AF37', 
                        goldLight: '#F9E27D' 
                    }, 
                    fontFamily: { 
                        serif: ['Playfair Display', 'serif'], 
                        sans: ['Poppins', 'sans-serif'], 
                        sport: ['Oswald', 'sans-serif'] 
                    } 
                } 
            }
        }
    </script>
    
    <style>
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #F9E27D 50%, #B8860B 100%); }
        
        /* PRINT SPECIFIC STYLING - HIGH PRECISION */
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            
            #printableArea { 
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }

            /* Layout Grid Cetak yang Lebih Rapi (3 Kolom) */
            #atletGrid { 
                display: grid; 
                grid-template-columns: repeat(3, 1fr); 
                gap: 15px; 
                row-gap: 20px;
            }
            
            /* Kartu Cetak */
            .card-atlet {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #e5e7eb;
                box-shadow: none;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <nav class="bg-maroon/95 backdrop-blur-md text-white p-4 sticky top-0 z-50 border-b border-gold/30 no-print shadow-md">
        <div class="container mx-auto flex justify-between items-center px-4">
            <a href="index.html" class="flex items-center gap-3">
                <img src="logo-csa.png" onerror="this.src='https://ui-avatars.com/api/?name=C+S&background=630000&color=fff'" class="h-10 w-10 border border-gold rounded-full bg-white p-0.5">
                <div class="flex flex-col leading-none">
                    <span class="text-lg font-serif font-bold text-gold tracking-wide">Champion</span>
                    <span class="text-[9px] tracking-[0.2em] uppercase text-gray-300">Sport Academy System</span>
                </div>
            </a>
            <div class="flex gap-4 text-[11px] font-bold uppercase tracking-widest">
                <a href="index.html" class="hover:text-gold transition">Home</a>
                <a href="rapor.html" class="hover:text-gold transition">Rapor Atlet</a>
            </div>
        </div>
    </nav>

    <section class="container mx-auto px-4 py-8 no-print">
        <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-maroon">
            <h1 class="text-2xl font-serif font-bold text-gray-800 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-sliders text-maroon text-lg"></i> Filter Laporan Tim
            </h1>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Bulan</label>
                    <div class="relative">
                        <select id="filterBulan" class="w-full bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg p-3 outline-none focus:border-maroon focus:ring-1 focus:ring-maroon font-medium appearance-none">
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Maret</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">Agustus</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs"></i>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Program</label>
                    <div class="relative">
                        <select id="filterCabor" onchange="updateWilayahOptions()" class="w-full bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg p-3 outline-none focus:border-maroon font-medium appearance-none">
                            <option value="">-- Pilih Program --</option>
                            <option value="Hapkido">Hapkido</option>
                            <option value="Karate">Karate</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs"></i>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Wilayah</label>
                    <div class="relative">
                        <select id="filterWilayah" class="w-full bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg p-3 outline-none focus:border-maroon font-medium appearance-none">
                            <option value="">-- Pilih Wilayah --</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs"></i>
                    </div>
                </div>

                <div class="flex items-end">
                    <button onclick="fetchData()" class="w-full bg-maroon hover:bg-maroonLight text-white text-sm font-bold py-3 rounded-lg shadow-md transition transform active:scale-95 uppercase tracking-wider">
                        <i class="fas fa-search mr-2"></i> Tampilkan Data
                    </button>
                </div>
            </div>
        </div>

        <div id="pdfAction" class="hidden mt-6 text-right fade-in">
            <button onclick="downloadPDF()" class="bg-gray-800 text-gold border border-gold hover:bg-black px-6 py-3 rounded-full text-xs font-bold uppercase tracking-widest shadow-lg inline-flex items-center gap-2 transition">
                <i class="fas fa-file-pdf text-lg"></i> Download PDF Resmi
            </button>
        </div>
    </section>

    <div id="loading" class="hidden text-center py-20">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-maroon mb-3"></div>
        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Sedang Memuat Data...</p>
    </div>

    <div id="errorState" class="hidden container mx-auto px-4">
        <div class="bg-red-50 border border-red-100 rounded-xl p-6 text-center max-w-lg mx-auto">
            <i class="fas fa-triangle-exclamation text-red-400 text-2xl mb-2"></i>
            <h3 class="text-maroon font-bold">Data Tidak Ditemukan</h3>
            <p class="text-xs text-gray-500 mt-1">Pastikan Anda memilih Wilayah & Program yang benar, atau cek koneksi internet.</p>
        </div>
    </div>

    <main id="printableArea" class="hidden bg-white mx-auto mb-20 shadow-2xl relative">
        <div class="p-8 md:p-12 max-w-4xl mx-auto">

            <header class="flex items-center justify-between pb-6 mb-6 border-b-4 border-double border-maroon">
                <div class="flex items-center gap-5">
                    <img src="logo-csa.png" onerror="this.src='https://ui-avatars.com/api/?name=CSA&background=630000&color=fff'" class="h-20 w-20 object-contain drop-shadow-sm">
                    <div>
                        <h1 class="text-3xl font-serif font-bold text-maroon uppercase tracking-tight leading-none">Champion Sport Academy</h1>
                        <p class="text-[10px] font-bold text-gold uppercase tracking-[0.35em] mt-1.5">Excellence in Martial Arts</p>
                        <p class="text-[10px] text-gray-500 mt-1 italic font-medium">Website: champion-sport-academy.netlify.app</p>
                    </div>
                </div>
                <div class="text-right hidden md:block">
                    <div class="bg-maroon text-white text-[10px] font-bold px-3 py-1 uppercase tracking-widest mb-1 inline-block">Official Report</div>
                    <div class="text-xs text-gray-500 font-serif italic">Generated by System</div>
                </div>
            </header>

            <div class="flex items-end justify-between mb-8">
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Laporan Evaluasi Kehadiran</p>
                    <h2 id="reportTitle" class="text-2xl font-serif font-bold text-gray-800 uppercase border-l-4 border-gold pl-4">Periode Januari 2026</h2>
                    <p id="reportSubtitle" class="text-sm font-semibold text-maroon pl-5 mt-1">HAPKIDO - KOTA CIMAHI</p>
                </div>
                
                <div class="flex gap-6 text-center bg-gray-50 px-6 py-3 rounded-lg border border-gray-100">
                    <div>
                        <div class="text-[9px] font-bold text-gray-400 uppercase tracking-wider">Total Atlet</div>
                        <div id="statTotal" class="text-xl font-serif font-bold text-maroon">0</div>
                    </div>
                    <div class="w-px bg-gray-200"></div>
                    <div>
                        <div class="text-[9px] font-bold text-gray-400 uppercase tracking-wider">Rata-rata</div>
                        <div id="statAvg" class="text-xl font-serif font-bold text-maroon">0%</div>
                    </div>
                    <div class="w-px bg-gray-200"></div>
                    <div>
                        <div class="text-[9px] font-bold text-gray-400 uppercase tracking-wider">Target Sesi</div>
                        <div id="statTarget" class="text-xl font-serif font-bold text-maroon">12</div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2 mb-4 text-[10px] text-gray-400 font-medium italic border-b border-gray-100 pb-2">
                <i class="fas fa-sort-amount-up"></i>
                <span>Data diurutkan dari absensi terendah ke tertinggi (Prioritas Evaluasi)</span>
            </div>

            <div id="atletGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                </div>

            <div class="mt-16 pt-8 flex justify-between items-end break-inside-avoid page-break-avoid">
                <div class="text-[10px] text-gray-400 font-medium">
                    <p>Dicetak pada: <span id="printDate" class="text-gray-600"></span></p>
                    <p>Dokumen ini sah dan digenerate otomatis.</p>
                </div>
                <div class="text-center w-48">
                    <div class="text-[10px] font-bold text-gray-400 uppercase mb-16 tracking-wider">Mengetahui, Pelatih Kepala</div>
                    <div class="border-b border-gray-800"></div>
                    <div class="text-[10px] font-bold text-maroon uppercase mt-2 tracking-widest">Champion Sport Academy</div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAg9NhPDYcmxERNMMc0xPAyl71vyQDqu17yXbPlAyJmcNdBd5xHrE8NYSaT-PcPeNksGYdV9lb97hC/pub?gid=1540868773&single=true&output=csv";

        // Data Wilayah (Mapping)
        const wilayahMap = {
            "Hapkido": ["Kota Cimahi", "KBB", "Kabupaten Bandung"],
            "Karate": ["KBB"]
        };
        
        let globalTargetSesi = 12;

        // Update Dropdown Wilayah saat Cabor dipilih
        function updateWilayahOptions() {
            const cabor = document.getElementById('filterCabor').value;
            const wilSelect = document.getElementById('filterWilayah');
            wilSelect.innerHTML = '<option value="">-- Pilih Wilayah --</option>';
            if (cabor && wilayahMap[cabor]) {
                wilayahMap[cabor].forEach(wil => {
                    const opt = document.createElement('option');
                    opt.value = wil; opt.text = wil;
                    wilSelect.appendChild(opt);
                });
            }
        }

        // Fungsi Download PDF
        function downloadPDF() {
            const element = document.getElementById('printableArea');
            // Pastikan layout cetak terlihat sepenuhnya
            const cabor = document.getElementById('filterCabor').value;
            const selBulan = document.getElementById('filterBulan');
            const namaBulan = selBulan.options[selBulan.selectedIndex].text;
            
            const opt = {
                margin: 0, // Margin ditangani oleh CSS @page
                filename: `Laporan_CSA_${cabor}_${namaBulan}.pdf`,
                image: { type: 'jpeg', quality: 1 }, // Kualitas maksimum
                html2canvas: { scale: 2, useCORS: true, letterRendering: true }, // Scale 2x untuk ketajaman
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        // Fetch Data Utama
        function fetchData() {
            const bulanVal = document.getElementById('filterBulan').value;
            const bulanText = document.getElementById('filterBulan').options[document.getElementById('filterBulan').selectedIndex].text;
            const cabor = document.getElementById('filterCabor').value;
            const wil = document.getElementById('filterWilayah').value;

            if (!cabor || !wil) {
                alert("Mohon pilih Program dan Wilayah terlebih dahulu.");
                return;
            }

            // UI Updates
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('printableArea').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('pdfAction').classList.add('hidden');

            // Update Header Laporan
            document.getElementById('reportTitle').innerText = `PERIODE ${bulanText.toUpperCase()} 2026`;
            document.getElementById('reportSubtitle').innerText = `${cabor.toUpperCase()} - ${wil.toUpperCase()}`;
            document.getElementById('printDate').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            Papa.parse(SPREADSHEET_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    processData(results, bulanText.toLowerCase(), bulanVal, cabor, wil);
                },
                error: function() {
                    document.getElementById('loading').classList.add('hidden');
                    alert("Gagal koneksi ke database.");
                }
            });
        }

        // Parsing Helper (Persen/Desimal)
        function parsePercent(val) {
            if (!val) return 0;
            let str = String(val).replace('%', '').replace(',', '.');
            let num = parseFloat(str);
            if (isNaN(num)) return 0;
            if (num <= 1 && num > 0) return Math.round(num * 100); // 0.8 -> 80
            return Math.round(num); // 80 -> 80
        }

        function processData(results, namaBulan, angkaBulan, cabor, wil) {
            // 1. Normalisasi Header
            const data = results.data.map(row => {
                const newRow = {};
                Object.keys(row).forEach(k => newRow[k.trim().toUpperCase()] = row[k]);
                return newRow;
            });

            // 2. Scan Target Sesi (Kolom Z)
            // Cari header kolom ke-26 (Index 25)
            const metaFields = results.meta.fields;
            const keyZ = (metaFields[25] || "").trim().toUpperCase();
            
            // Cari baris yang mengandung nama bulan di kolom Z untuk ambil "12x"
            const rowInfo = data.find(d => {
                const val = (d[keyZ] || "").toLowerCase();
                return val.includes(namaBulan) || val.includes(`bulan ${angkaBulan}`);
            });

            if (rowInfo) {
                const match = (rowInfo[keyZ] || "").match(/(\d+)\s*x/);
                globalTargetSesi = match ? parseInt(match[1]) : 12;
            } else {
                globalTargetSesi = 12;
            }

            // 3. Filter Data
            let filtered = data.filter(item => {
                // Filter Wilayah (Fuzzy Match)
                const dbWil = (item["WILAYAH"] || "").toLowerCase().replace(/[\s\.]/g, "");
                const targetWil = wil.toLowerCase().replace(/[\s\.]/g, "");
                
                let matchWil = false;
                if (targetWil.includes("cimahi") && dbWil.includes("cimahi")) matchWil = true;
                else if (targetWil.includes("kbb") && (dbWil.includes("kbb") || dbWil.includes("bandungbarat"))) matchWil = true;
                else if (targetWil.includes("bandung") && !targetWil.includes("barat") && dbWil.includes("bandung") && !dbWil.includes("barat")) matchWil = true;

                // Filter Cabor
                const dbProg = (item["PROGRAM YANG DIPILIH"] || "").toLowerCase();
                if (!dbProg.includes(cabor.toLowerCase())) return false;

                // Filter Periode (Cek Kolom Z atau fallback bulan Januari)
                const valZ = (item[keyZ] || "").toLowerCase();
                let matchTime = false;
                if (valZ.includes(namaBulan)) matchTime = true;
                else if (valZ.includes(`bulan ${angkaBulan}`) || valZ.includes(`bulan 0${angkaBulan}`)) matchTime = true;
                else if (valZ.trim() === "" && angkaBulan == 1) matchTime = true; // Fallback Januari

                return matchWil && matchTime;
            });

            // 4. Sorting (Terendah -> Tertinggi)
            filtered.sort((a, b) => parsePercent(a["ABSENSI"]) - parsePercent(b["ABSENSI"]));

            if (filtered.length === 0) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
            } else {
                renderGrid(filtered);
            }
        }

        function renderGrid(data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('printableArea').classList.remove('hidden');
            document.getElementById('pdfAction').classList.remove('hidden');

            // Update Statistik
            document.getElementById('statTotal').innerText = data.length;
            document.getElementById('statTarget').innerText = globalTargetSesi;

            let totalP = 0;
            const grid = document.getElementById('atletGrid');
            grid.innerHTML = "";

            data.forEach(atlet => {
                const nama = atlet["NAMA LENGKAP"] || "Tanpa Nama";
                const absenVal = parsePercent(atlet["ABSENSI"]);
                totalP += absenVal;

                const hadirCount = Math.round((absenVal / 100) * globalTargetSesi);
                const foto = (atlet["FOTO TERBAIK"] && atlet["FOTO TERBAIK"].length > 10) 
                             ? atlet["FOTO TERBAIK"] 
                             : `https://ui-avatars.com/api/?name=${encodeURIComponent(nama)}&background=630000&color=fff&size=128`;

                // Tentukan Warna & Status
                let theme = "border-red-200 bg-red-50/30";
                let textCol = "text-red-700";
                let barCol = "bg-red-500";
                let statusLabel = "Kurang";

                if (absenVal >= 80) {
                    theme = "border-green-200 bg-green-50/30";
                    textCol = "text-green-700";
                    barCol = "bg-green-600";
                    statusLabel = "Sangat Baik";
                } else if (absenVal >= 60) {
                    theme = "border-yellow-200 bg-yellow-50/30";
                    textCol = "text-yellow-700";
                    barCol = "bg-yellow-500";
                    statusLabel = "Cukup";
                }

                // --- DESAIN KARTU BARU (COMPACT & ELEGANT) ---
                grid.innerHTML += `
                <div class="card-atlet relative flex items-center gap-3 p-3 rounded-lg border ${theme} bg-white transition hover:shadow-md">
                    <div class="relative shrink-0">
                        <img src="${foto}" class="w-14 h-14 rounded-full object-cover border-2 border-white shadow-sm ring-1 ring-gray-100">
                        <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 shadow-sm">
                             <div class="w-4 h-4 rounded-full ${barCol} border-2 border-white"></div>
                        </div>
                    </div>
                    
                    <div class="flex-grow min-w-0">
                        <h3 class="font-serif font-bold text-gray-800 text-sm truncate leading-tight mb-1">${nama}</h3>
                        
                        <div class="flex justify-between items-center text-[10px] uppercase font-bold text-gray-400 mb-1">
                            <span>${statusLabel}</span>
                            <span class="${textCol}">${hadirCount}/${globalTargetSesi} Sesi</span>
                        </div>
                        
                        <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                            <div class="${barCol} h-full rounded-full" style="width: ${Math.min(absenVal, 100)}%"></div>
                        </div>
                        <div class="text-right mt-0.5">
                            <span class="text-[10px] font-bold ${textCol}">${absenVal}%</span>
                        </div>
                    </div>
                </div>
                `;
            });

            // Update Rata-rata Global
            const avg = Math.round(totalP / data.length);
            document.getElementById('statAvg').innerText = avg + "%";
        }
    </script>
</body>
</html>
