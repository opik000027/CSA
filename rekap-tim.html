<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Laporan Tim - Champion Sport Academy</title>
    
    <link rel="icon" type="image/png" href="logo-csa.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&family=Oswald:wght@700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: { maroon: '#630000', gold: '#D4AF37' }, 
                    fontFamily: { display: ['Playfair Display', 'serif'], sans: ['Poppins', 'sans-serif'], sport: ['Oswald', 'sans-serif'] } 
                } 
            }
        }
    </script>
    
    <style>
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #F9E27D 50%, #B8860B 100%); }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            #printableArea { box-shadow: none; border: none; padding: 0; margin: 0; width: 100%; }
            #atletGrid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
            .card-atlet { break-inside: avoid; page-break-inside: avoid; border: 1px solid #eee; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <nav class="bg-maroon/95 backdrop-blur-md text-white p-4 sticky top-0 z-50 border-b border-gold/30 no-print">
        <div class="container mx-auto flex justify-between items-center px-4">
            <a href="index.html" class="flex items-center gap-3 group">
                <img src="logo-csa.png" class="h-10 w-10 border border-gold rounded-full bg-white shadow-lg object-contain p-0.5">
                <div class="flex flex-col leading-none">
                    <span class="text-lg font-display font-bold text-gold uppercase tracking-tight">Champion</span>
                    <span class="text-[9px] tracking-[0.2em] italic uppercase text-gray-300">Team Report</span>
                </div>
            </a>
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-[10px] font-bold uppercase tracking-widest hover:text-gold transition">Home</a>
                <a href="rapor.html" class="text-[10px] font-bold uppercase tracking-widest hover:text-gold transition">Rapor Atlet</a>
            </div>
        </div>
    </nav>

    <section class="bg-maroon pt-12 pb-24 px-6 text-center text-white border-b-4 border-gold relative overflow-hidden no-print">
        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
        <div class="container mx-auto relative z-10">
            <h1 class="text-3xl md:text-5xl font-display font-bold text-gold uppercase mb-2 drop-shadow-md">Rekapitulasi Tim</h1>
            <p class="text-gray-300 font-sport uppercase tracking-[0.2em] text-xs italic">Evaluasi Kehadiran & Performa Bulanan</p>
        </div>
    </section>

    <section class="container mx-auto px-4 md:px-6 -mt-16 relative z-20 no-print">
        <div class="bg-white p-6 md:p-8 rounded-[2.5rem] shadow-2xl border border-gray-100 grid grid-cols-1 md:grid-cols-4 gap-5 items-end">
            
            <div class="group">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-3 mb-1 block">Periode Laporan</label>
                <div class="relative">
                    <select id="filterBulan" class="w-full border-2 border-gray-100 bg-gray-50 rounded-2xl p-4 outline-none focus:border-gold font-bold text-sm appearance-none cursor-pointer">
                        <option value="1">Januari</option>
                        <option value="2">Februari</option>
                        <option value="3">Maret</option>
                        <option value="4">April</option>
                        <option value="5">Mei</option>
                        <option value="6">Juni</option>
                        <option value="7">Juli</option>
                        <option value="8">Agustus</option>
                        <option value="9">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">Desember</option>
                    </select>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"><i class="fas fa-chevron-down"></i></div>
                </div>
            </div>

            <div class="group">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-3 mb-1 block">Cabang Olahraga</label>
                <div class="relative">
                    <select id="filterCabor" onchange="updateWilayahOptions()" class="w-full border-2 border-gray-100 bg-gray-50 rounded-2xl p-4 outline-none focus:border-gold font-bold text-sm appearance-none cursor-pointer">
                        <option value="">-- Pilih Cabang --</option>
                        <option value="Hapkido">Hapkido</option>
                        <option value="Karate">Karate</option>
                    </select>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"><i class="fas fa-chevron-down"></i></div>
                </div>
            </div>

            <div class="group">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-3 mb-1 block">Wilayah</label>
                <div class="relative">
                    <select id="filterWilayah" class="w-full border-2 border-gray-100 bg-gray-50 rounded-2xl p-4 outline-none focus:border-gold font-bold text-sm appearance-none cursor-pointer">
                        <option value="">-- Pilih Wilayah --</option>
                    </select>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"><i class="fas fa-chevron-down"></i></div>
                </div>
            </div>

            <div>
                <button onclick="fetchData()" class="w-full gold-gradient text-maroon font-bold py-4 rounded-2xl shadow-lg hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-widest text-xs flex justify-center items-center gap-2">
                    Tampilkan Data <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </section>

    <main class="flex-grow container mx-auto px-4 md:px-6 py-12">
        
        <div id="loading" class="text-center py-20 hidden">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-gold border-t-maroon mb-4"></div>
            <p class="font-bold text-maroon uppercase text-xs tracking-[0.2em] animate-pulse">Menghubungkan Database...</p>
        </div>

        <div id="pdfAction" class="hidden text-right mb-6 no-print fade-in">
            <button onclick="downloadPDF()" class="bg-gray-800 text-gold border border-gold px-6 py-3 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-black transition shadow-lg inline-flex items-center gap-2">
                <i class="fas fa-file-pdf text-lg"></i> Download PDF Laporan
            </button>
        </div>

        <div id="printableArea" class="hidden bg-white p-8 md:p-12 rounded-[2.5rem] shadow-none md:shadow-xl border-none md:border border-gray-100">
            
            <div class="flex items-center justify-between border-b-2 border-gray-100 pb-8 mb-8">
                <div class="flex items-center gap-4">
                    <img src="logo-csa.png" class="h-16 md:h-20 w-16 md:w-20 object-contain" onerror="this.style.display='none'">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-display font-bold text-maroon uppercase leading-none">Laporan Evaluasi</h2>
                        <p class="text-[10px] md:text-xs font-bold text-gold uppercase tracking-[0.2em] mt-1">Champion Sport Academy</p>
                    </div>
                </div>
                <div class="text-right">
                    <div id="reportPeriod" class="text-xl md:text-2xl font-sport font-bold text-gray-800 uppercase">PERIODE --</div>
                    <div id="reportDetail" class="text-xs text-gray-500 font-bold uppercase tracking-wider mt-1">--</div>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-4 mb-10">
                <div class="bg-gray-50 p-4 rounded-2xl text-center border border-gray-100">
                    <div class="text-[9px] text-gray-400 uppercase font-bold mb-1 tracking-widest">Total Atlet</div>
                    <div id="statTotal" class="text-2xl md:text-3xl font-sport text-maroon font-bold">0</div>
                </div>
                <div class="bg-gray-50 p-4 rounded-2xl text-center border border-gray-100">
                    <div class="text-[9px] text-gray-400 uppercase font-bold mb-1 tracking-widest">Rata-rata</div>
                    <div id="statAvg" class="text-2xl md:text-3xl font-sport text-maroon font-bold">0%</div>
                </div>
                <div class="bg-gray-50 p-4 rounded-2xl text-center border border-gray-100">
                    <div class="text-[9px] text-gray-400 uppercase font-bold mb-1 tracking-widest">Target Sesi</div>
                    <div id="labelTotalSesi" class="text-2xl md:text-3xl font-sport text-maroon font-bold">12</div>
                </div>
                <div class="bg-gray-50 p-4 rounded-2xl text-center border border-gray-100">
                    <div class="text-[9px] text-gray-400 uppercase font-bold mb-1 tracking-widest">Status Tim</div>
                    <div id="statStatus" class="text-[10px] font-bold text-white bg-maroon px-2 py-1 rounded-lg uppercase inline-block mt-1">Check</div>
                </div>
            </div>

            <div id="atletGrid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>

            <div class="mt-16 pt-8 border-t border-gray-200 flex justify-between items-end break-inside-avoid">
                <div class="text-[10px] text-gray-400 italic">
                    <p>Dokumen ini digenerate otomatis oleh sistem CSA.</p>
                    <p class="mt-1">Dicetak pada: <span id="printDate" class="font-bold"></span></p>
                </div>
                <div class="text-center w-48">
                    <div class="text-[10px] font-bold text-gray-500 uppercase mb-16">Mengetahui, Pelatih Kepala</div>
                    <div class="border-b border-gray-800"></div>
                    <div class="text-[10px] font-bold text-maroon uppercase mt-2 tracking-wider">Champion Sport Academy</div>
                </div>
            </div>
        </div>
        
        <div id="emptyState" class="text-center py-20 opacity-40">
            <i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-400 uppercase text-xs tracking-widest">Pilih filter di atas untuk menampilkan data</p>
        </div>

        <div id="errorState" class="hidden text-center py-10 bg-red-50 rounded-[2rem] border border-red-100 mt-4 mx-auto max-w-2xl">
            <i class="fas fa-exclamation-circle text-3xl text-red-400 mb-3"></i>
            <p class="text-red-800 font-bold uppercase text-xs tracking-widest">Data Tidak Ditemukan</p>
            <p class="text-[10px] text-gray-500 mt-2 px-8">
                Data kehadiran 0% atau atlet tidak ditemukan.<br>
                Cek kolom <strong>"ABSENSI"</strong> di Spreadsheet Anda.
            </p>
        </div>

    </main>

    <footer class="bg-black text-white py-10 text-center border-t-4 border-gold mt-auto no-print">
        <p class="font-display text-gold text-lg italic uppercase tracking-[0.1em] font-bold mb-2">Champion Sport Academy</p>
        <p class="text-[9px] text-gray-600 tracking-[0.5em] uppercase">Â© 2026 Internal Team System</p>
    </footer>

    <script>
        const spreadsheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAg9NhPDYcmxERNMMc0xPAyl71vyQDqu17yXbPlAyJmcNdBd5xHrE8NYSaT-PcPeNksGYdV9lb97hC/pub?gid=1540868773&single=true&output=csv";

        const wilayahData = {
            "Hapkido": ["Kota Cimahi", "KBB", "Kabupaten Bandung"],
            "Karate": ["KBB"]
        };
        
        let totalSesiDitemukan = 12; 

        function updateWilayahOptions() {
            const cabor = document.getElementById('filterCabor').value;
            const wilSelect = document.getElementById('filterWilayah');
            wilSelect.innerHTML = '<option value="">-- Pilih Wilayah --</option>';
            if (cabor && wilayahData[cabor]) {
                wilayahData[cabor].forEach(wil => {
                    const opt = document.createElement('option');
                    opt.value = wil; opt.text = wil;
                    wilSelect.appendChild(opt);
                });
            }
        }

        function downloadPDF() {
            const element = document.getElementById('printableArea');
            const cabor = document.getElementById('filterCabor').value;
            const selBulan = document.getElementById('filterBulan');
            const namaBulan = selBulan.options[selBulan.selectedIndex].text; 
            
            const opt = {
                margin: 10,
                filename: `Rekap_CSA_${cabor}_${namaBulan}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function fetchData() {
            const angkaBulan = document.getElementById('filterBulan').value; 
            const selBulan = document.getElementById('filterBulan');
            const namaBulan = selBulan.options[selBulan.selectedIndex].text.toLowerCase(); // "januari"

            const cabor = document.getElementById('filterCabor').value;
            const wil = document.getElementById('filterWilayah').value;

            if (!cabor || !wil) { alert("Mohon lengkapi pilihan Cabang & Wilayah!"); return; }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('printableArea').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('pdfAction').classList.add('hidden');
            
            document.getElementById('reportPeriod').innerText = `PERIODE ${namaBulan.toUpperCase()} 2026`;
            document.getElementById('reportDetail').innerText = `${cabor.toUpperCase()} - ${wil.toUpperCase()}`;
            document.getElementById('printDate').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            Papa.parse(spreadsheetUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    processSpreadsheetData(results, namaBulan, angkaBulan, cabor, wil);
                },
                error: function() {
                    alert("Gagal mengambil data. Periksa koneksi internet.");
                    document.getElementById('loading').classList.add('hidden');
                }
            });
        }

        function processSpreadsheetData(results, namaBulan, angkaBulan, cabor, wil) {
            // 1. NORMALISASI HEADER (MEMBUAT SEMUA HEADER JADI HURUF BESAR)
            // Ini kunci agar "Absensi" terbaca sebagai "ABSENSI"
            const data = results.data.map(row => {
                const newRow = {};
                Object.keys(row).forEach(key => {
                    newRow[key.trim().toUpperCase()] = row[key]; // Ubah key jadi UPPERCASE
                });
                return newRow;
            });

            // 2. SCAN TOTAL SESI (DARI KOLOM Z / INDEX 25)
            // Karena header dinormalisasi, kita harus mencari header kolom ke-26 dari meta asli
            const originalHeaders = results.meta.fields;
            const keyKolomZ = (originalHeaders[25] || "").trim().toUpperCase(); // Pastikan ambil header kolom Z dan kapitalkan

            const sampleRow = data.find(item => {
                const isiKolomZ = (keyKolomZ && item[keyKolomZ]) ? item[keyKolomZ].toString().toLowerCase() : "";
                return isiKolomZ.includes(namaBulan) || isiKolomZ.includes(`bulan ${angkaBulan}`);
            });

            if (sampleRow) {
                const isiKolomZ = sampleRow[keyKolomZ].toString().toLowerCase();
                const match = isiKolomZ.match(/(\d+)\s*x/);
                totalSesiDitemukan = (match && match[1]) ? parseInt(match[1]) : 12;
            } else {
                totalSesiDitemukan = 12;
            }

            // 3. FILTER DATA UTAMA
            const filteredData = data.filter(item => {
                const dbWilayah = (item["WILAYAH"] || "").toLowerCase().replace(/[\s\.]/g, ""); 
                const filterWilayah = wil.toLowerCase().replace(/[\s\.]/g, "");
                
                let matchWilayah = false;
                if (filterWilayah.includes("cimahi") && dbWilayah.includes("cimahi")) matchWilayah = true;
                else if (filterWilayah.includes("kbb") && (dbWilayah.includes("kbb") || dbWilayah.includes("bandungbarat"))) matchWilayah = true;
                else if (filterWilayah.includes("bandung") && !filterWilayah.includes("barat") && dbWilayah.includes("bandung") && !dbWilayah.includes("barat")) matchWilayah = true;

                const dbProgram = (item["PROGRAM YANG DIPILIH"] || "").toLowerCase();
                if (!dbProgram.includes(cabor.toLowerCase())) return false;

                // PERIODE (BACA KOLOM Z)
                const isiKolomZ = (keyKolomZ && item[keyKolomZ]) ? item[keyKolomZ].toString().toLowerCase() : "";
                
                let matchPeriode = false;
                if (isiKolomZ.includes(namaBulan)) matchPeriode = true;
                else if (isiKolomZ.includes(`bulan ${angkaBulan}`) || isiKolomZ.includes(`bulan 0${angkaBulan}`)) matchPeriode = true;
                else if (isiKolomZ.includes(`${angkaBulan}/2026`)) matchPeriode = true;
                
                // Fallback jika Z kosong tapi bulan Januari
                if (isiKolomZ.trim() === "" && angkaBulan == 1) matchPeriode = true;

                return matchWilayah && matchPeriode;
            });

            if (filteredData.length === 0) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
            } else {
                renderGrid(filteredData);
            }
        }

        function renderGrid(data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('printableArea').classList.remove('hidden');
            document.getElementById('pdfAction').classList.remove('hidden');
            
            document.getElementById('labelTotalSesi').innerText = totalSesiDitemukan;
            document.getElementById('statTotal').innerText = data.length;

            const grid = document.getElementById('atletGrid');
            grid.innerHTML = ''; 

            let totalPersen = 0;

            data.forEach((atlet) => {
                const nama = atlet["NAMA LENGKAP"] || "Tanpa Nama";
                
                // DATA KUNCI: ABSENSI (Pastikan Header sudah UPPERCASE)
                const persentase = parseInt(atlet["ABSENSI"]) || 0; 
                totalPersen += persentase;

                const hadir = Math.round((persentase / 100) * totalSesiDitemukan);
                const fotoRaw = atlet["FOTO TERBAIK"];
                const foto = (fotoRaw && fotoRaw.length > 10) ? fotoRaw : `https://ui-avatars.com/api/?name=${encodeURIComponent(nama)}&background=630000&color=fff&bold=true`;
                let colorClass = persentase >= 80 ? 'text-green-600' : (persentase >= 60 ? 'text-yellow-600' : 'text-red-600');

                grid.innerHTML += `
                    <div class="card-atlet bg-gray-50 rounded-2xl p-4 text-center border border-gray-100 flex flex-col items-center">
                        <img src="${foto}" class="w-16 h-16 rounded-full object-cover border-2 border-gold shadow-sm mb-3 bg-white">
                        <h3 class="font-sport text-xs text-maroon uppercase font-bold leading-tight mb-1 line-clamp-1 w-full">${nama}</h3>
                        <div class="mt-auto pt-2 w-full">
                            <div class="bg-white border border-gray-200 rounded-lg py-1 px-2">
                                <span class="text-[10px] font-bold ${colorClass}">
                                    ${hadir} / ${totalSesiDitemukan} (${persentase}%)
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });

            const avg = Math.round(totalPersen / data.length);
            document.getElementById('statAvg').innerText = avg + "%";
            
            const statusEl = document.getElementById('statStatus');
            if (avg >= 80) {
                statusEl.innerText = "Excellent";
                statusEl.className = "text-[10px] font-bold text-white bg-green-600 px-3 py-1 rounded-lg uppercase inline-block mt-1";
            } else if (avg >= 60) {
                statusEl.innerText = "Good";
                statusEl.className = "text-[10px] font-bold text-white bg-blue-600 px-3 py-1 rounded-lg uppercase inline-block mt-1";
            } else {
                statusEl.innerText = "Need Focus";
                statusEl.className = "text-[10px] font-bold text-white bg-red-500 px-3 py-1 rounded-lg uppercase inline-block mt-1";
            }
        }
    </script>
</body>
</html>
