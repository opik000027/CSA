<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Laporan Tim - Champion Sport Academy</title>
    
    <link rel="icon" type="image/png" href="logo-csa.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&family=Oswald:wght@700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: { maroon: '#630000', gold: '#D4AF37' }, 
                    fontFamily: { display: ['Playfair Display', 'serif'], sans: ['Poppins', 'sans-serif'], sport: ['Oswald', 'sans-serif'] } 
                } 
            }
        }
    </script>
    
    <style>
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #F9E27D 50%, #B8860B 100%); }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* PENGATURAN KHUSUS CETAK DOKUMEN */
        @media print {
            .no-print { display: none !important; } /* Sembunyikan navbar/tombol saat diprint */
            body { background: white; -webkit-print-color-adjust: exact; }
            #printableArea { box-shadow: none; border: none; padding: 0; margin: 0; width: 100%; }
            #atletGrid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; } /* Paksa 4 kolom di kertas */
            .break-inside-avoid { page-break-inside: avoid; } /* Mencegah foto terpotong antar halaman */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <nav class="bg-maroon text-white p-4 sticky top-0 z-50 border-b border-gold/30 shadow-md no-print">
        <div class="container mx-auto flex justify-between items-center px-4">
            <a href="index.html" class="flex items-center gap-3 hover:opacity-80 transition group">
                <i class="fas fa-chevron-left text-gold group-hover:-translate-x-1 transition-transform"></i>
                <span class="text-xs font-bold uppercase tracking-widest">Kembali ke Home</span>
            </a>
            <div class="flex items-center gap-2">
                <img src="logo-csa.png" class="h-8 w-8 rounded-full bg-white p-0.5 border border-gold object-contain" onerror="this.style.display='none'">
                <span class="font-display font-bold text-gold text-sm uppercase italic hidden md:block">Team Performance</span>
            </div>
        </div>
    </nav>

    <header class="bg-maroon py-12 text-center text-white border-b-4 border-gold relative overflow-hidden no-print">
        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
        <div class="container mx-auto px-6 relative z-10">
            <h1 class="text-4xl md:text-5xl font-display font-bold text-gold uppercase mb-3 drop-shadow-md">Monthly Evaluation</h1>
            <p id="displayPeriode" class="text-gray-300 font-sport uppercase tracking-[0.2em] text-xs italic">Sistem Laporan & Evaluasi Atlet</p>
        </div>
    </header>

    <section class="container mx-auto px-6 -mt-8 relative z-20 no-print">
        <div class="bg-white p-6 rounded-[2rem] shadow-2xl border border-gray-100 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1 block">Bulan</label>
                <select id="filterBulan" class="w-full border-2 border-gray-100 bg-gray-50 rounded-2xl p-3 outline-none focus:border-gold font-bold text-sm">
                    <option value="1">Januari</option>
                    <option value="2">Februari</option>
                    <option value="3">Maret</option>
                    <option value="4">April</option>
                    <option value="5">Mei</option>
                    <option value="6">Juni</option>
                    <option value="7">Juli</option>
                    <option value="8">Agustus</option>
                    <option value="9">September</option>
                    <option value="10">Oktober</option>
                    <option value="11">November</option>
                    <option value="12">Desember</option>
                </select>
            </div>

            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1 block">Cabang</label>
                <select id="filterCabor" onchange="updateWilayahOptions()" class="w-full border-2 border-gray-100 bg-gray-50 rounded-2xl p-3 outline-none focus:border-gold font-bold text-sm">
                    <option value="">-- Pilih Cabang --</option>
                    <option value="Hapkido">Hapkido</option>
                    <option value="Karate">Karate</option>
                </select>
            </div>

            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1 block">Wilayah</label>
                <select id="filterWilayah" class="w-full border-2 border-gray-100 bg-gray-50 rounded-2xl p-3 outline-none focus:border-gold font-bold text-sm">
                    <option value="">-- Pilih Wilayah --</option>
                </select>
            </div>

            <div>
                <button onclick="fetchData()" class="w-full gold-gradient text-maroon font-bold py-3 rounded-2xl shadow-lg hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-widest text-xs">
                    Tampilkan Data <i class="fas fa-search ml-1"></i>
                </button>
            </div>
        </div>
    </section>

    <main class="flex-grow container mx-auto px-6 py-12">
        
        <div id="loading" class="text-center py-20 hidden">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-gold border-t-maroon mb-4"></div>
            <p class="font-bold text-maroon uppercase text-xs tracking-[0.2em] animate-pulse">Sedang Memproses Data...</p>
        </div>

        <div id="pdfAction" class="hidden text-right mb-4 no-print fade-in">
            <button onclick="downloadPDF()" class="bg-gray-800 text-gold border border-gold px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-black transition shadow-lg flex items-center gap-2 ml-auto">
                <i class="fas fa-file-pdf"></i> Simpan sebagai PDF
            </button>
            <p class="text-[9px] text-gray-400 mt-1">atau tekan Ctrl + P untuk print langsung</p>
        </div>

        <div id="printableArea" class="hidden bg-white p-8 rounded-[2rem] shadow-none md:shadow-xl border-none md:border border-gray-100">
            
            <div class="text-center mb-6 border-b-2 border-gray-100 pb-6">
                <img src="logo-csa.png" class="h-16 mx-auto mb-2" onerror="this.style.display='none'">
                <h2 class="text-2xl font-display font-bold text-maroon uppercase">Laporan Evaluasi Bulanan</h2>
                <p id="reportTitle" class="text-sm font-sport text-gold tracking-[0.2em] uppercase font-bold mt-1">--</p>
                <p class="text-[10px] text-gray-400 mt-2">Champion Sport Academy System</p>
            </div>

            <div class="grid grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-50 p-3 rounded-xl text-center border border-gray-200">
                    <div class="text-[8px] text-gray-500 uppercase font-bold mb-1 tracking-widest">Total Atlet</div>
                    <div id="statTotal" class="text-xl font-sport text-maroon font-bold">0</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl text-center border border-gray-200">
                    <div class="text-[8px] text-gray-500 uppercase font-bold mb-1 tracking-widest">Rata-rata</div>
                    <div id="statAvg" class="text-xl font-sport text-maroon font-bold">0%</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl text-center border border-gray-200">
                    <div class="text-[8px] text-gray-500 uppercase font-bold mb-1 tracking-widest">Total Sesi</div>
                    <div id="labelTotalSesi" class="text-xl font-sport text-maroon font-bold">12</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl text-center border border-gray-200">
                    <div class="text-[8px] text-gray-500 uppercase font-bold mb-1 tracking-widest">Status</div>
                    <div id="statStatus" class="text-[9px] font-bold text-green-600 uppercase mt-1">Checking</div>
                </div>
            </div>

            <div id="atletGrid" class="grid grid-cols-3 md:grid-cols-4 gap-6"></div>

            <div class="mt-12 pt-6 border-t border-gray-200 flex justify-between items-end break-inside-avoid">
                <div class="text-[9px] text-gray-400">
                    <p>Dicetak otomatis oleh sistem.</p>
                    <p class="mt-1">Tanggal Cetak: <span id="printDate"></span></p>
                </div>
                <div class="text-center">
                    <div class="h-16"></div> 
                    <p class="text-[10px] font-bold text-maroon uppercase border-t border-gray-400 pt-2 px-8">Mengetahui, Pelatih</p>
                </div>
            </div>
        </div>
        
        <div id="emptyState" class="text-center py-20 opacity-50">
            <i class="fas fa-clipboard-check text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-400 uppercase text-xs tracking-widest">Siap menampilkan laporan</p>
        </div>
        <div id="errorState" class="hidden text-center py-12 bg-red-50 rounded-[2rem] border border-red-100 mt-4 mx-auto max-w-2xl">
            <i class="fas fa-exclamation-circle text-4xl text-red-300 mb-4"></i>
            <p class="text-red-800 font-bold uppercase text-xs tracking-widest mb-2">Data Tidak Ditemukan</p>
            <p class="text-[10px] text-gray-500 px-8">Cek kembali filter Cabang & Wilayah Anda.</p>
        </div>

    </main>

    <footer class="bg-black text-white py-8 text-center border-t-4 border-gold mt-auto no-print">
        <p class="font-display text-gold text-lg italic uppercase tracking-[0.1em] font-bold mb-2">Champion Sport Academy</p>
        <p class="text-[9px] text-gray-600 tracking-[0.5em] uppercase">© 2026 Internal System</p>
    </footer>

    <script>
        const spreadsheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAg9NhPDYcmxERNMMc0xPAyl71vyQDqu17yXbPlAyJmcNdBd5xHrE8NYSaT-PcPeNksGYdV9lb97hC/pub?gid=1540868773&single=true&output=csv";

        const wilayahData = {
            "Hapkido": ["Kota Cimahi", "KBB", "Kabupaten Bandung"],
            "Karate": ["KBB"]
        };
        
        let totalSesiDitemukan = 12; // Default

        function updateWilayahOptions() {
            const cabor = document.getElementById('filterCabor').value;
            const wilSelect = document.getElementById('filterWilayah');
            wilSelect.innerHTML = '<option value="">-- Pilih Wilayah --</option>';
            if (cabor && wilayahData[cabor]) {
                wilayahData[cabor].forEach(wil => {
                    const opt = document.createElement('option');
                    opt.value = wil; opt.text = wil;
                    wilSelect.appendChild(opt);
                });
            }
        }

        // FUNGSI DOWNLOAD PDF
        function downloadPDF() {
            const element = document.getElementById('printableArea');
            const cabor = document.getElementById('filterCabor').value;
            const selBulan = document.getElementById('filterBulan');
            const namaBulan = selBulan.options[selBulan.selectedIndex].text; 
            
            const opt = {
                margin:       [10, 10, 10, 10], // Margin kertas (mm)
                filename:     `Laporan_CSA_${cabor}_${namaBulan}_2026.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true }, // Resolusi tinggi
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            // Proses generate
            html2pdf().set(opt).from(element).save();
        }

        function fetchData() {
            const angkaBulan = document.getElementById('filterBulan').value; 
            const selBulan = document.getElementById('filterBulan');
            const namaBulan = selBulan.options[selBulan.selectedIndex].text.toLowerCase(); 

            const cabor = document.getElementById('filterCabor').value;
            const wil = document.getElementById('filterWilayah').value;

            if (!cabor || !wil) { alert("Lengkapi filter Cabang & Wilayah!"); return; }

            // UI Reset
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('printableArea').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('pdfAction').classList.add('hidden');
            
            // Judul Laporan
            document.getElementById('reportTitle').innerText = `PERIODE: ${namaBulan.toUpperCase()} 2026 • ${cabor.toUpperCase()} • ${wil.toUpperCase()}`;
            const today = new Date();
            document.getElementById('printDate').innerText = today.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            Papa.parse(spreadsheetUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    
                    // 1. CARI TOTAL SESI (LOGIKA 12X)
                    const sampleRow = results.data.find(item => {
                        const k = (item["KETERANGAN"] || "").toLowerCase();
                        return k.includes(namaBulan) || k.includes(`bulan ${angkaBulan}`) || k.includes(`/${angkaBulan}/`);
                    });

                    if (sampleRow) {
                        const infoKeterangan = sampleRow["KETERANGAN"].toLowerCase();
                        const matchSesi = infoKeterangan.match(/(\d+)\s*x/); 
                        if (matchSesi && matchSesi[1]) {
                            totalSesiDitemukan = parseInt(matchSesi[1]);
                        } else {
                            totalSesiDitemukan = 12; // Reset ke default jika tidak ada info "x"
                        }
                    }

                    // 2. FILTER DATA
                    const filteredData = results.data.filter(item => {
                        const dbProgram = (item["PROGRAM YANG DIPILIH"] || "").toLowerCase();
                        const dbWilayah = (item["WILAYAH"] || "").toLowerCase().replace(/[\s\.]/g, ""); 
                        const dbKeterangan = (item["KETERANGAN"] || "").toLowerCase();

                        const filterProgram = cabor.toLowerCase();
                        const filterWilayah = wil.toLowerCase().replace(/[\s\.]/g, "");

                        let matchWilayah = false;
                        if (filterWilayah.includes("cimahi") && dbWilayah.includes("cimahi")) matchWilayah = true;
                        else if (filterWilayah.includes("kbb") && (dbWilayah.includes("kbb") || dbWilayah.includes("bandungbarat"))) matchWilayah = true;
                        else if (filterWilayah.includes("bandung") && !filterWilayah.includes("barat") && dbWilayah.includes("bandung") && !dbWilayah.includes("barat")) matchWilayah = true;

                        const matchProgram = dbProgram.includes(filterProgram);

                        let matchPeriode = false;
                        if (dbKeterangan.includes(namaBulan)) matchPeriode = true;
                        else if (dbKeterangan.includes(`bulan ${angkaBulan}`) || dbKeterangan.includes(`bulan 0${angkaBulan}`)) matchPeriode = true;
                        else if (dbKeterangan.includes(`${angkaBulan}/2026`)) matchPeriode = true;

                        return matchProgram && matchWilayah && matchPeriode;
                    });

                    if (filteredData.length === 0) {
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('errorState').classList.remove('hidden');
                    } else {
                        renderData(filteredData);
                    }
                },
                error: function() {
                    alert("Gagal koneksi database.");
                    document.getElementById('loading').classList.add('hidden');
                }
            });
        }

        function renderData(data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('printableArea').classList.remove('hidden');
            document.getElementById('pdfAction').classList.remove('hidden');
            
            // Update Angka Total Sesi di UI
            document.getElementById('labelTotalSesi').innerText = totalSesiDitemukan;

            const grid = document.getElementById('atletGrid');
            grid.innerHTML = ''; 

            let totalPersen = 0;

            data.forEach((atlet, index) => {
                const nama = atlet["NAMA LENGKAP"] || "Tanpa Nama";
                const persentase = parseInt(atlet["ABSENSI"]) || 0;
                
                // Rumus Hitung
                const hadir = Math.round((persentase / 100) * totalSesiDitemukan);
                
                const fotoRaw = atlet["FOTO TERBAIK"];
                const foto = (fotoRaw && fotoRaw.length > 5) ? fotoRaw : `https://ui-avatars.com/api/?name=${encodeURIComponent(nama)}&background=630000&color=fff&size=128&bold=true`;

                totalPersen += persentase;

                grid.innerHTML += `
                    <div class="text-center p-2 mb-2 break-inside-avoid">
                        <img src="${foto}" class="w-16 h-16 rounded-full mx-auto mb-2 object-cover border-2 border-gold shadow-sm bg-gray-100">
                        <h3 class="font-sport text-[10px] text-maroon uppercase font-bold leading-tight line-clamp-1">${nama}</h3>
                        <div class="mt-1 bg-gray-50 rounded px-2 py-1 inline-block border border-gray-100">
                             <span class="text-[10px] font-bold ${persentase >= 80 ? 'text-green-700' : 'text-orange-600'}">${hadir}/${totalSesiDitemukan} (${persentase}%)</span>
                        </div>
                    </div>
                `;
            });

            const avgPresence = Math.round(totalPersen / data.length);
            updateStats(data.length, avgPresence);
        }

        function updateStats(total, avg) {
            document.getElementById('statTotal').innerText = total;
            document.getElementById('statAvg').innerText = avg + "%";
            
            const statusEl = document.getElementById('statStatus');
            if (avg >= 85) {
                statusEl.innerText = "Excellent";
                statusEl.className = "text-[9px] font-bold text-green-700 uppercase mt-2 bg-green-50 px-2 py-1 rounded border border-green-200";
            } else if (avg >= 70) {
                statusEl.innerText = "Good";
                statusEl.className = "text-[9px] font-bold text-blue-700 uppercase mt-2 bg-blue-50 px-2 py-1 rounded border border-blue-200";
            } else {
                statusEl.innerText = "Warning";
                statusEl.className = "text-[9px] font-bold text-orange-700 uppercase mt-2 bg-orange-50 px-2 py-1 rounded border border-orange-200";
            }
        }
    </script>
</body>
</html>
